<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Link Builder â€” Builder + Redirect (Apps Script)</title>

<!-- CDN CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body{background:#f6f7fb;padding:20px}
  .card{max-width:980px;margin:12px auto;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(20,24,40,0.06)}
  .small-muted{font-size:.88rem;color:#6b7280}
  .store-input{margin-bottom:8px}
  .result-box{word-break:break-all;font-family:Menlo,monospace;background:#0f172a;color:#fff;padding:10px;border-radius:6px}
  .hint{font-size:.86rem;color:#6b7280}
  .badge-btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:8px;border:1px solid #e6e8ef;background:#fff}
  .preview-badges{display:flex;gap:8px;flex-wrap:wrap}
  footer.small{color:#94a3b8;margin-top:12px}
</style>
</head>
<body>
  <div class="card">
    <!-- ... keep all builder UI unchanged ... -->

<!-- CDN JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js" crossorigin="anonymous"></script>

<script>
/* ====== CONFIG ====== */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6zyFq7aHIDoyVJEX3pawCQxHfq1SuWQYjXZZdvGAf6t3Ck7VZQhFy7GrfY4k3jD0P/exec";

/* ====== Helpers ====== */
function b64urlEncode(str){ return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function b64urlDecode(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4)s+='='; try{return decodeURIComponent(escape(atob(s)));}catch(e){return null;} }
function nowIso(){ return new Date().toISOString(); }
function buildPayload(){
  const stores = {
    apple: $("#link-apple").val().trim(),
    google: $("#link-google").val().trim(),
    huawei: $("#link-huawei").val().trim(),
    samsung: $("#link-samsung").val().trim(),
    amazon: $("#link-amazon").val().trim(),
    microsoft: $("#link-microsoft").val().trim(),
    apkpure: $("#link-apkpure").val().trim(),
    web: $("#link-web").val().trim()
  };
  const utms={};
  ["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(k=>{
    const v=$("#"+k).val().trim(); if(v) utms[k]=v;
  });
  const analytics={type:$("#analytics_type").val(),value:$("#analytics_value").val().trim()};
  const slug=$("#slug").val().trim();
  return {stores,utms,analytics,slug,created_at:nowIso()};
}
function atLeastOneStore(stores){ return Object.values(stores).some(v=>v&&v.length>0); }

/* ====== Local Storage ====== */
function saveLocal(name,payload){
  const saved=JSON.parse(localStorage.getItem("sl_configs")||"{}");
  saved[name]=payload;
  localStorage.setItem("sl_configs",JSON.stringify(saved));
}
function showSaved(){
  const saved=JSON.parse(localStorage.getItem("sl_configs")||"{}");
  const $out=$("#savedList").empty();
  const keys=Object.keys(saved);
  if(keys.length===0){ $out.text("No saved configs in browser."); return; }
  keys.forEach(k=>{
    const row=$("<div>").addClass("d-flex align-items-center gap-2 mb-1");
    row.append($("<div>").text(k).css({"fontFamily":"monospace","minWidth":"180px"}));
    const openBtn=$("<button>").addClass("btn btn-sm btn-outline-primary").text("Open");
    openBtn.on("click",()=>{ const payload=saved[k]; const encoded=b64urlEncode(JSON.stringify(payload)); window.open(location.origin+location.pathname+"#/r/"+encoded,"_blank"); });
    const shortBtn=$("<button>").addClass("btn btn-sm btn-outline-success").text("Open short");
    shortBtn.on("click",()=>{ const payload=saved[k]; const slugName=payload.slug||k; window.open(location.origin+location.pathname+"#/s/"+encodeURIComponent(slugName),"_blank"); });
    const delBtn=$("<button>").addClass("btn btn-sm btn-outline-danger").text("Delete");
    delBtn.on("click",()=>{ if(!confirm("Delete this saved config?")) return; delete saved[k]; localStorage.setItem("sl_configs",JSON.stringify(saved)); showSaved(); });
    row.append(openBtn,shortBtn,delBtn);
    $out.append(row);
  });
}

/* ====== Platform & URL Helpers ====== */
function detectPlatform(){
  const ua=navigator.userAgent||navigator.vendor||"";
  if(/ipad|iphone|ipod/i.test(ua)&&!/android/i.test(ua)) return "apple";
  if(/huawei/i.test(ua)) return "huawei";
  if(/samsung/i.test(ua)) return "samsung";
  if(/android/i.test(ua)) return "google";
  if(/windows phone/i.test(ua)) return "microsoft";
  if(/windows/i.test(ua)&&/touch/.test(ua)) return "microsoft";
  return "web";
}
function appendUtmsToUrl(url,utms){
  try{ const u=new URL(url); for(const k in utms) if(utms[k]) u.searchParams.set(k,utms[k]); return u.toString(); }catch(e){ return url; }
}

/* ====== Analytics Injector ====== */
function injectAnalytics(analytics){
  if(!analytics||!analytics.type) return;
  const t=analytics.type,v=analytics.value;
  if(t==="plausible"&&v){ const s=document.createElement("script"); s.defer=true; s.setAttribute("data-domain",v); s.src="https://plausible.io/js/script.js"; document.head.appendChild(s); }
  else if(t==="ga4"&&v){ const s1=document.createElement("script"); s1.async=true; s1.src="https://www.googletagmanager.com/gtag/js?id="+v; document.head.appendChild(s1); const s2=document.createElement("script"); s2.text="window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','"+v+"');"; document.head.appendChild(s2); }
  else if(t==="umami"&&v){ const parts=v.split("|"); if(parts.length===2){ const s=document.createElement("script"); s.defer=true; s.dataset.websiteId=parts[1]; s.src=parts[0]; document.head.appendChild(s); } }
  else if(t==="custom"&&v){ const s=document.createElement("script"); s.defer=true; s.src=v; document.head.appendChild(s); }
}

/* ====== Apps Script API helpers with CORS + JSONP fallback ====== */
function saveToAppsScript(endpoint,slug,payload){
  return fetch(endpoint,{method:"POST",mode:"cors",headers:{'Content-Type':'application/json'},body:JSON.stringify({action:"save",slug,payload})})
    .then(r=>r.json()).catch(e=>{
      // fallback JSONP
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Date.now(); window[cb]=data=>{ resolve(data); delete window[cb]; };
        const s=document.createElement("script");
        s.src=endpoint+'?action=save&slug='+encodeURIComponent(slug)+'&payload='+encodeURIComponent(JSON.stringify(payload))+'&callback='+cb;
        s.onerror=e=>reject(e); document.body.appendChild(s);
      });
    });
}
function fetchFromAppsScript(endpoint,slug){
  return fetch(endpoint+'?action=get&slug='+encodeURIComponent(slug),{method:"GET",mode:"cors"})
    .then(r=>r.json()).catch(e=>{
      // fallback JSONP
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Date.now(); window[cb]=data=>{ resolve(data); delete window[cb]; };
        const s=document.createElement("script");
        s.src=endpoint+'?action=get&slug='+encodeURIComponent(slug)+'&callback='+cb;
        s.onerror=e=>reject(e); document.body.appendChild(s);
      });
    });
}

/* ====== All your existing UI wiring and routing remains unchanged ====== */
/* ... copy the full existing script below as-is, replace saveToAppsScript and fetchFromAppsScript with above versions ... */

$(function(){
  new ClipboardJS('#copyBtn',{text:()=>$("#finalUrl").text()});
  showSaved();
  // ... rest of your existing event handlers ...
});
</script>
</body>
</html>
